<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RESONA - Find Your Sound's Soulmate</title>
    <script src="https://cdn.tailwindcss.com"></script>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸª‰</text></svg>">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif; /* A clean, modern font often used with Tailwind */
        }
        .hero-bg {
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1770&q=80'); /* Example music-themed background */
            background-size: cover;
            background-position: center;
        }
        .glassmorphism-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem; /* 16px */
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
         .btn-primary {
            background-color: #F9A8D4; /* A soft pink, can be changed */
            color: #1F2937; /* Dark gray */
        }
        .btn-primary:hover {
            background-color: #F472B6;
        }
        .section-card {
            background-color: rgba(255, 255, 255, 0.05); /* Slightly more opaque than glassmorphism for readability */
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Navbar -->
    <nav class="bg-gray-900/70 backdrop-blur-md shadow-lg fixed w-full z-20 top-0 left-0 border-b border-gray-700">
        <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
            <a href="#" class="flex items-center space-x-3 rtl:space-x-reverse">
                <span class="self-center text-3xl font-semibold whitespace-nowrap bg-clip-text text-transparent bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500">RESONA</span>
            </a>
            <div class="flex md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse">
                <button type="button" class="text-white bg-pink-600 hover:bg-pink-700 focus:ring-4 focus:outline-none focus:ring-pink-400 font-medium rounded-lg text-sm px-4 py-2 text-center">
                    Get Started
                </button>
                <button data-collapse-toggle="navbar-sticky" type="button" class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-400 rounded-lg md:hidden hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600" aria-controls="navbar-sticky" aria-expanded="false">
                    <span class="sr-only">Open main menu</span>
                    <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"/>
                    </svg>
                </button>
            </div>
            <div class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1" id="navbar-sticky">
                <ul class="flex flex-col p-4 md:p-0 mt-4 font-medium border border-gray-700 rounded-lg bg-gray-800 md:bg-transparent md:space-x-8 rtl:space-x-reverse md:flex-row md:mt-0 md:border-0">
                    <li>
                        <a href="#" class="block py-2 px-3 text-white bg-pink-600 rounded md:bg-transparent md:text-pink-500 md:p-0" aria-current="page">Home</a>
                    </li>
                    <li>
                        <a href="#how-it-works" class="block py-2 px-3 text-gray-300 rounded hover:bg-gray-700 md:hover:bg-transparent md:hover:text-pink-500 md:p-0">How It Works</a>
                    </li>
                    <li>
                        <a href="#discover" class="block py-2 px-3 text-gray-300 rounded hover:bg-gray-700 md:hover:bg-transparent md:hover:text-pink-500 md:p-0">Discover</a>
                    </li>
                    <li>
                        <a href="#community" class="block py-2 px-3 text-gray-300 rounded hover:bg-gray-700 md:hover:bg-transparent md:hover:text-pink-500 md:p-0">Community</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-bg min-h-screen flex items-center justify-center pt-20">
        <div class="container mx-auto px-6 py-16 text-center">
            <div class="glassmorphism-card p-8 md:p-12 max-w-3xl mx-auto">
                <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight">
                    Find Your <span class="bg-clip-text text-transparent bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500">Sound's Soulmate</span>
                </h1>
                <p class="text-lg md:text-xl mb-8 text-gray-300">
                    Love a specific moment in a song? RESONA helps you discover other tracks with that exact same vibe. Paste a YouTube link & timestamp, and let the magic happen.
                </p>
                <form id="segment-form" class="space-y-6">
                    <div>
                        <label for="youtube-url" class="block mb-2 text-sm font-medium text-gray-200">YouTube URL (with timestamp, e.g., &t=1m30s)</label>
                        <input type="url" id="youtube-url" name="youtube_url" class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-pink-500 focus:border-pink-500 block w-full p-3 placeholder-gray-400" placeholder="https://www.youtube.com/watch?v=dQw4w9WgXcQ&t=43s" required>
                    </div>
                    <button type="submit" id="analyze-button" class="w-full text-white bg-gradient-to-r from-pink-600 via-red-500 to-yellow-500 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-pink-400 font-medium rounded-lg text-lg px-5 py-3.5 text-center">
                        <span id="button-text">Analyze Segment</span>
                        <svg id="loading-spinner" aria-hidden="true" role="status" class="inline w-4 h-4 me-3 text-white animate-spin hidden" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="#E5E7EB"/>
                            <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentColor"/>
                        </svg>
                    </button>
                </form>
                <p class="mt-4 text-xs text-gray-400">Or <button id="upload-audio-button" class="text-pink-400 hover:underline">upload an audio file</button> (MP3, WAV, max 10MB).</p>
                <input type="file" id="audio-file-input" class="hidden" accept=".mp3,.wav,.ogg,.m4a">
            </div>
        </div>
    </section>

    <!-- Results Section -->
    <section id="discover" class="py-16 md:py-24 bg-gray-900">
        <div class="container mx-auto px-6">
            <h2 class="text-3xl md:text-4xl font-bold text-center mb-12">Segments <span class="bg-clip-text text-transparent bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500">You Might Love</span></h2>
            <div id="results-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Placeholder for results - JS will populate this -->
                <div id="results-placeholder" class="text-center col-span-full text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto mb-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 13.5V3.75m0 9.75a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 3.75V16.5m12-3V3.75m0 9.75a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 3.75V16.5m-6-9V3.75m0 5.25a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 3.75V16.5m-6 3.75h18" />
                    </svg>
                    <p>Submit a YouTube link above to find similar song segments!</p>
                    <p class="text-sm mt-2">Or try one of these examples (coming soon!)</p>
                </div>

                <!-- Example Result Card (template for JS) -->
                <!--
                <div class="section-card p-0 overflow-hidden result-card hidden">
                    <img src="https://via.placeholder.com/400x225/333/fff?text=Album+Art" alt="Album Art" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-1">Song Title - Artist Name</h3>
                        <p class="text-sm text-pink-400 mb-2">Segment: 1:23 - 1:53 (Similar Vibe)</p>
                        <p class="text-gray-400 text-sm mb-3">Matched Features: Epic trumpets, rising tension, 120 BPM</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded">92% Match</span>
                            <a href="#" target="_blank" class="text-sm text-gray-300 hover:text-pink-400 flex items-center">
                                Listen on YouTube
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1">
                                  <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 17h-8.5A2.25 2.25 0 012 14.75v-8.5A2.25 2.25 0 014.25 4h5a.75.75 0 010 1.5h-5z" clip-rule="evenodd" />
                                  <path fill-rule="evenodd" d="M6.194 12.753a.75.75 0 001.06.053L16.5 4.44v2.81a.75.75 0 001.5 0v-4.5a.75.75 0 00-.75-.75h-4.5a.75.75 0 000 1.5h2.553l-9.056 8.19a.75.75 0 00-.053 1.06z" clip-rule="evenodd" />
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
                -->
            </div>
        </div>
    </section>

    <!-- How It Works Section -->
    <section id="how-it-works" class="py-16 md:py-24 bg-gray-800">
        <div class="container mx-auto px-6">
            <h2 class="text-3xl md:text-4xl font-bold text-center mb-12">How <span class="bg-clip-text text-transparent bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500">RESONA</span> Works Its Magic</h2>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="section-card text-center p-6 hover:shadow-pink-500/30 transition-shadow duration-300">
                    <div class="mb-4 text-pink-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">1. Submit Your Spark</h3>
                    <p class="text-gray-400">Paste a YouTube link with a timestamp (e.g. ...&t=1m23s) or upload a short audio clip (15-60s) of that musical moment you love.</p>
                </div>
                <div class="section-card text-center p-6 hover:shadow-red-500/30 transition-shadow duration-300">
                    <div class="mb-4 text-red-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M9 9l10.5-3m0 6.553v3.75a2.25 2.25 0 01-1.632 2.163l-1.32.377a1.803 1.803 0 11-.99-3.467l2.31-.66a2.25 2.25 0 001.632-2.163zm0 0V2.25L9 5.25v5.053m0 0v2.828m0 0l-2.137.983A2.25 2.25 0 014.03 14.612v-2.127a2.25 2.25 0 011.03-1.919l2.137-.983z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">2. We Analyze The Vibe</h3>
                    <p class="text-gray-400">Our AI listens closely, extracting key musical features like melody, harmony, rhythm, and timbre to understand its unique essence.</p>
                </div>
                <div class="section-card text-center p-6 hover:shadow-yellow-500/30 transition-shadow duration-300">
                    <div class="mb-4 text-yellow-400">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z" />
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">3. Discover Similar Moments</h3>
                    <p class="text-gray-400">RESONA searches its growing library to find other song segments that share that special sonic fingerprint and emotional impact.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Community Section (Placeholder) -->
    <section id="community" class="py-16 md:py-24 bg-gray-800">
        <div class="container mx-auto px-6 text-center">
            <h2 class="text-3xl md:text-4xl font-bold mb-6">Join the <span class="bg-clip-text text-transparent bg-gradient-to-r from-pink-500 via-red-500 to-yellow-500">RESONA Community</span></h2>
            <p class="text-lg text-gray-400 mb-8 max-w-2xl mx-auto">Share your favorite musical moments, discover curated segment playlists, and connect with fellow sound explorers. Coming soon!</p>
            <button class="text-white bg-gradient-to-r from-pink-600 via-red-500 to-yellow-500 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-pink-400 font-medium rounded-lg text-lg px-8 py-4 text-center">
                Notify Me
            </button>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 border-t border-gray-700">
        <div class="container mx-auto px-6 py-8 text-center text-gray-400">
            <p>&copy; <span id="current-year"></span> RESONA. All rights reserved. Discovering music, one segment at a time.</p>
            <p class="text-sm mt-2">Built with <span class="text-pink-400">&hearts;</span> and Pure JavaScript, Tailwind CSS, Python & Firebase.</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
    <script>
        // Basic Setup
        document.getElementById('current-year').textContent = new Date().getFullYear();

        const segmentForm = document.getElementById('segment-form');
        const youtubeUrlInput = document.getElementById('youtube-url');
        const analyzeButton = document.getElementById('analyze-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultsContainer = document.getElementById('results-container');
        const resultsPlaceholder = document.getElementById('results-placeholder');
        const uploadAudioButton = document.getElementById('upload-audio-button');
        const audioFileInput = document.getElementById('audio-file-input');

        // Event Listeners
        segmentForm.addEventListener('submit', handleFormSubmit);
        uploadAudioButton.addEventListener('click', () => audioFileInput.click());
        audioFileInput.addEventListener('change', handleFileUpload);

        // State Management
        let isLoading = false;

        function setLoading(loading) {
            isLoading = loading;
            if (loading) {
                buttonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                analyzeButton.disabled = true;
                youtubeUrlInput.disabled = true;
            } else {
                buttonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                analyzeButton.disabled = false;
                youtubeUrlInput.disabled = false;
            }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            if (isLoading) return;

            const youtubeUrl = youtubeUrlInput.value.trim();
            if (!youtubeUrl) {
                alert('Please enter a YouTube URL.'); // Replace with a nicer notification later
                return;
            }

            // Basic URL validation (can be improved)
            try {
                const url = new URL(youtubeUrl);
                if (url.hostname !== 'www.youtube.com' && url.hostname !== 'youtube.com' && url.hostname !== 'youtu.be') {
                     alert('Please enter a valid YouTube URL.');
                     return;
                }
            } catch (_) {
                alert('Invalid URL format.');
                return;
            }
            
            setLoading(true);
            resultsPlaceholder.innerHTML = '<p class="text-gray-400">Analyzing segment... this might take a moment!</p><div class="mt-4"><div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-pink-500 mx-auto"></div></div>';
            clearResults();

            try {
                const response = await fetch('/api/analyze-segment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ youtube_url: youtubeUrl })
                });

                if (!response.ok) {
                    let errorDetail = response.statusText;
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.detail || JSON.stringify(errorData);
                    } catch (jsonError) {
                        console.error("Could not parse error JSON:", jsonError);
                    }
                    throw new Error(errorDetail);
                }

                const data = await response.json();
                console.log("Data received from API:", data);
                
                if (data && data.source_segment_info) {
                    displayResults(data.similar_segments, data.source_segment_info);
                } else {
                    console.error("API response missing expected structure (source_segment_info or similar_segments):", data);
                    throw new Error("Received malformed data from server.");
                }

            } catch (error) {
                console.error('Error analyzing segment:', error);
                resultsPlaceholder.innerHTML = `<p class="text-red-400">Error: ${error.message}. Please try again.</p>`;
                resultsPlaceholder.classList.remove('hidden');
            } finally {
                setLoading(false);
            }
        }

        async function handleFileUpload(event) {
            if (isLoading) return;
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert("File is too large. Maximum size is 10MB.");
                audioFileInput.value = ""; // Reset file input
                return;
            }

            setLoading(true);
            resultsPlaceholder.innerHTML = '<p class="text-gray-400">Uploading and analyzing audio... this might take a moment!</p><div class="mt-4"><div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-pink-500 mx-auto"></div></div>';
            clearResults();

            const formData = new FormData();
            formData.append('audio_file', file);

            try {
                const response = await fetch('/api/analyze-audio', {
                    method: 'POST',
                    body: formData // No 'Content-Type' header needed, browser sets it for FormData
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error during audio upload' }));
                    throw new Error(errorData.detail || `Server error: ${response.status}`);
                }

                const data = await response.json();
                displayResults(data.similar_segments, data.source_segment_info);

            } catch (error) {
                console.error('Error analyzing uploaded audio:', error);
                resultsPlaceholder.innerHTML = `<p class="text-red-400">Error: ${error.message}. Please try again.</p>`;
                resultsPlaceholder.classList.remove('hidden');
            } finally {
                setLoading(false);
                audioFileInput.value = ""; // Reset file input
            }
        }

        function clearResults() {
            // Remove all children from resultsContainer that are actual result cards
            const cardsToRemove = resultsContainer.querySelectorAll('.result-card');
            cardsToRemove.forEach(card => resultsContainer.removeChild(card));
            
            // Ensure placeholder is hidden initially when clearing for new results
            resultsPlaceholder.classList.add('hidden');
        }

        function displayResults(segments, sourceInfo) {
            // 1. Clear only previous result cards (elements with class 'result-card')
            const cardsToRemove = resultsContainer.querySelectorAll('.result-card');
            cardsToRemove.forEach(card => resultsContainer.removeChild(card));

            // 2. Assume placeholder should be hidden if we are about to display results
            resultsPlaceholder.classList.add('hidden');
            let hasContentToDisplay = false;

            // 3. Add Source Card if available
            if (sourceInfo) {
                const sourceCard = createResultCard(sourceInfo, true);
                // Prepend source card so it's always first, before placeholder or similar cards
                resultsContainer.prepend(sourceCard); 
                hasContentToDisplay = true;
            }

            // 4. Add Similar Segment Cards if available
            if (segments && segments.length > 0) {
                segments.forEach(segment => {
                    const card = createResultCard(segment);
                    resultsContainer.appendChild(card); // Append similar cards
                });
                hasContentToDisplay = true;
            }

            // 5. Update and show placeholder ONLY if NO cards were displayed OR if source was displayed but NO similar segments
            if (!hasContentToDisplay) {
                // No source, no similar segments - show initial "Submit a link" message
                resultsPlaceholder.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mx-auto mb-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 13.5V3.75m0 9.75a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 3.75V16.5m12-3V3.75m0 9.75a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 3.75V16.5m-6-9V3.75m0 5.25a1.5 1.5 0 010 3m0-3a1.5 1.5 0 000 3m0 3.75V16.5m-6 3.75h18" /></svg><p>Submit a YouTube link above to find similar song segments!</p><p class="text-sm mt-2">Or try one of these examples (coming soon!)</p>';
                resultsPlaceholder.classList.remove('hidden');
            } else if (sourceInfo && (!segments || segments.length === 0)) {
                // Source was displayed, but no similar segments found
                resultsPlaceholder.innerHTML = '<p class="text-gray-400 text-center col-span-full">No similar segments found for this submission yet. Stay tuned!</p>';
                resultsPlaceholder.classList.remove('hidden');
                // Ensure placeholder is the last child in this case
                resultsContainer.appendChild(resultsPlaceholder);
            }
            // If hasContentToDisplay is true AND there are segments, then placeholder remains hidden.
        }

        function createResultCard(segment, isSource = false) {
            const card = document.createElement('div');
            card.className = 'section-card p-0 overflow-hidden result-card';
            if (isSource) {
                card.classList.add('border-2', 'border-pink-500', 'shadow-pink-500/50');
            }

            // Sanitize inputs
            const title = segment.title ? escapeHtml(segment.title) : 'Unknown Title';
            const artist = segment.artist ? escapeHtml(segment.artist) : 'Unknown Artist';
            const segmentTime = segment.segment_display_time ? escapeHtml(segment.segment_display_time) : 'N/A';
            const similarity = segment.similarity_score ? (segment.similarity_score * 100).toFixed(0) + '%' : '';
            const youtubeLink = segment.youtube_link ? escapeHtml(segment.youtube_link) : '#';
            const thumbnailUrl = segment.thumbnail_url || 'https://placehold.co/400x225/4A5568/A0AEC0?text=No+Preview&font=lora'; // Changed placeholder URL

            let featuresHtml = '';
            if (segment.matched_features && segment.matched_features.length > 0) {
                featuresHtml = `<p class="text-gray-400 text-xs mb-3"><strong>Features:</strong> ${segment.matched_features.map(f => escapeHtml(f)).join(', ')}</p>`;
            } else if (isSource) {
                featuresHtml = `<p class="text-gray-400 text-xs mb-3">This is the segment you submitted.</p>`;
            }


            card.innerHTML = `
                <img src="${thumbnailUrl}" alt="Thumbnail for ${title}" class="w-full h-48 object-cover">
                <div class="p-4">
                    <h3 class="text-lg font-semibold mb-1 truncate" title="${title} - ${artist}">${title} - ${artist}</h3>
                    <p class="text-sm text-pink-400 mb-2">Segment: ${segmentTime}</p>
                    ${featuresHtml}
                    <div class="flex items-center justify-between">
                        ${similarity && !isSource ? `<span class="text-xs bg-yellow-500/30 text-yellow-200 px-2 py-1 rounded font-medium">${similarity} Match</span>` : (isSource ? '<span class="text-xs bg-pink-500/30 text-pink-300 px-2 py-1 rounded font-medium">Your Submission</span>' : '')}
                        ${youtubeLink !== '#' ? `
                        <a href="${youtubeLink}" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-300 hover:text-pink-400 flex items-center">
                            ${isSource ? 'View Original' : 'Listen on YouTube'}
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1">
                              <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 17h-8.5A2.25 2.25 0 012 14.75v-8.5A2.25 2.25 0 014.25 4h5a.75.75 0 010 1.5h-5z" clip-rule="evenodd" />
                              <path fill-rule="evenodd" d="M6.194 12.753a.75.75 0 001.06.053L16.5 4.44v2.81a.75.75 0 001.5 0v-4.5a.75.75 0 00-.75-.75h-4.5a.75.75 0 000 1.5h2.553l-9.056 8.19a.75.75 0 00-.053 1.06z" clip-rule="evenodd" />
                            </svg>
                        </a>` : ''}
                    </div>
                </div>
            `;
            return card;
        }

        function escapeHtml(unsafe) {
            if (unsafe === null || typeof unsafe === 'undefined') return '';
            return unsafe
                 .toString()
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // Initialize Flowbite for dynamic components like navbar collapse
        // Ensure Flowbite is loaded before this script or use DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // Any Flowbite specific initializations if needed, though often it initializes itself
        });

    </script>
</body>
</html>
